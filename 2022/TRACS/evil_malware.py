#!/usr/bin/python3

import os
import sys
import random
from Crypto.Cipher import Blowfish
from Crypto.Hash import SHA256
from Crypto.Util.number import bytes_to_long

import pickle

filename = sys.argv[1]
with open(filename, "rb") as f:
    data = f.read()


def derivation(buf, n):
    ret = buf[:]
    for i in range(n):
        x = b''
        for c in ret:
            x += b'%X' % c
        h = SHA256.new()
        h.update(x)
        ret = h.digest()
    return ret


N = 107432977185950290289416741649199945007638843008792997324779404768244225092561607689734944711696600299859344233412431621988246274123128221489877283833331324476987804803364145697393742458543765224900352789688640134043078256150509010956909235120830127504153969333426545234882130547530909701987904659156965893001



if __name__ == '__main__':
    session_key = bytes([random.SystemRandom().getrandbits(8) for __ in range(32)])
    nsk = bytes_to_long(session_key)


    s = nsk % 1000000000
    x = []
    for i in range(8):
        x += [s >> 16]
        s = ((s * 123456789) + 23) % 2147483648
    nh = (-8 * x[0] + 4 * x[2] - x[4] + 2 * x[5] + 7 * x[7]) % (2**15)
    nc = (-x[0] + 2 * x[1] + 2 * x[2] - 2 * x[3] + 6 * x[4] - 11 * x[5] - 6 * x[6] - 2 * x[7]) % (2**15)


    len_plain = len(data)
    h = SHA256.new()
    h.update(data)
    hash_plain = h.hexdigest()


    len_crypt = ((len_plain + 7) // 8) * 8
    padding = b'\xff' * (len_crypt - len_plain)

    buf = session_key + bytes(filename, encoding='utf8')
    
    new_name = derivation(buf, nh).hex() + '.vault'
    cipher_key = derivation(buf, nc)
    

    iv = bytes([0, 0, 0, 0, 0, 0, 0, 0])
    cipher = Blowfish.new(cipher_key, Blowfish.MODE_CBC, iv)
    crypt_data = cipher.encrypt(data + padding)

    encrypted_session_key = pow(nsk, 65537, N)
    locked_file = { "crypt_data" : crypt_data, "length" : len_plain, "encrypted_session_key": encrypted_session_key, "hash" : hash_plain, "name" : filename}


    with open(new_name, "wb") as f:
        f.write(pickle.dumps(locked_file))

    # os.unlink(filename)   # commentÃ© pour raison pratique
    print(f'{filename} -> {new_name}')
